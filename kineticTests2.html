
<!--
  Tutorials:
  http://jsfiddle.net/robtown/SGQq7/22/
-->
<!DOCTYPE HTML>
<html>
    <head>
        <style>
            body {
                margin: 0px;
                padding: 0px;
            }
            canvas {
                border: 1px solid #9C9898;
            }
        </style>
        <script src="src/lib/kinetic-v4.0.5.min.js"></script>
        <script>
            imageCount = 0;

            window.onload = function() {
              var lowY;
              var highY;

              var newLine;
              var newLinePoints = [];
              var prevPos;
              var mode;

              document.getElementById("drawMode").addEventListener("click", function() {
                mode = "draw";
              }, false);

              document.getElementById("eraseMode").addEventListener("click", function() {
                mode = "erase";
              }, false);

                layer = new Kinetic.Layer();
                layerLines = new Kinetic.Layer();
                textLayer = new Kinetic.Layer();

                var simpleText = new Kinetic.Text({
                  x: 190,
                  y: 15,
                  text: "Simple Text",
                  fontSize: 30,
                  fontFamily: "Calibri",
                  textFill: "green"
                });

                var complexText = new Kinetic.Text({
                  x: 100,
                  y: 60,
                  stroke: '#555',
                  strokeWidth: 5,
                  fill: '#ddd',
                  text: 'COMPLEX TEXT\n\nAll the world\'s a stage, and all the men and women merely players. They have their exits and their entrances.',
                  fontSize: 14,
                  fontFamily: 'Calibri',
                  textFill: '#555',
                  width: 380,
                  padding: 20,
                  align: 'center',
                  fontStyle: 'italic',
                  shadow: {
                    color: 'black',
                    blur: 1,
                    offset: [10, 10],
                    opacity: 0.2
                  },
                  cornerRadius: 10
                });

                stage = new Kinetic.Stage({
                    container: "container",
                    width: 640,
                    height: 320
                });
                GloStage = stage;

                background = new Kinetic.Rect({
                    x: 0, 
                    y: 0, 
                    width: stage.getWidth(),
                    height: stage.getHeight(),
                    fill: "white"
                });
    
                layer.add(background);
                line = new Kinetic.Line({
                    points: [0, 0, 50, 50],
                    stroke: "red"
                });

                layerLines.add(line);
                stage.add(layer);
                stage.add(layerLines);
                stage.add(textLayer); // in front of "draw" layer, i.e. cant draw on a diagnosis. for now.
                moving = false;

                // Drag start
                stage.on("mousedown", function(){
                  dragStart();
                });

                stage.on("touchstart", function(){
                  dragStart();
                });

                function dragStart() {
                    console.log('dragStart');
                    if (mode !== 'draw') {
                      return;
                    }

                    if (moving){
                        moving = false;layer.draw();
                    } else {
                        
                        // var mousePos = stage.getMousePosition();
                        // //start point and end point are the same
                        // line.getPoints()[0].x = mousePos.x;
                        // line.getPoints()[0].y = mousePos.y;
                        // line.getPoints()[1].x = mousePos.x;
                        // line.getPoints()[1].y = mousePos.y;

                        newLinePoints = [];
                        // prevPos = stage.getMousePosition();
                        prevPos = stage.getUserPosition();  // Mouse or touch
                        // console.log("mousePos = ", prevPos.x, prevPos.y);
                        
                        newLinePoints.push(prevPos);
                        newLine = new Kinetic.Line({
                          points: newLinePoints,
                          stroke: "red",
                        });
                        layerLines.add(newLine);
                        moving = true;    
                        // layerLines.drawScene();            

                        newLine.on('mouseover', function(evt){
                          console.log('clicked on newline');
                          if (mode == 'erase') {
                            console.log('fake erase');
                          }
                        });
                        
                    }
                  }

                // Keep track of current low and high
                function updateBounds(mousePos) {
                    var y = mousePos.y;
                    if (y < lowY || lowY == undefined) { lowY = y; }
                    if (y > highY || highY == undefined) { highY = y; console.log("hi = " + y)}
                }


                // Drag in progress
                stage.on("mousemove", function(){ dragMove(); });
                stage.on("touchmove", function(){ dragMove(); });

                // function dragMove_touch(e) {
                //   var x, y, i;
                //   for (i = 0; i < e.targetTouches.length; i++) {
                //       console.log()
                //       x = e.targetTouches[i].clientX - offsetX;
                //       y = e.targetTouches[i].clientY - offsetY;
                //       drawCircle(x, y);
                //   }
                // }

                function dragMove(){
                    console.log('dragMove');
                    if (mode !== 'draw') {
                      return;
                    }

                    if (moving) {
                        
                        // var mousePos = stage.getMousePosition();
                        var mousePos = stage.getUserPosition();  // Mouse or touch

                        // console.log("mousePos = ", mousePos.x, mousePos.y);
                        var x = mousePos.x;
                        var y = mousePos.y;
                        newLinePoints.push(mousePos);
                        updateBounds(mousePos)
;
                        // console.log("moving");
                        
                        prevPos = mousePos;
                        // console.log(newLine);
                        
                        moving = true;
                        layerLines.drawScene();
                    }
                }
                
                // Done dragging
                stage.on("mouseup", function(){dragComplete();});
                stage.on("touchend", function(){dragComplete();});
                
                function dragComplete(){
                    console.log('drag complete');
                    if (mode !== 'draw') {
                      return;
                    }

                    moving = false; 
                }

                document.getElementById("saveCanvas").addEventListener("click", function() {
                  /*
                   * since the stage toDataURL() method is asynchronous, we need
                   * to provide a callback
                   */
                  stage.toDataURL({
                    callback: function(dataUrl) {
                      /*
                       * here you can do anything you like with the data url.
                       * In this tutorial we'll just open the url with the browser
                       * so that you can see the result as an image
                       */
                      localStorage.setItem('imageFromVisit' + imageCount, dataUrl);
                      createThumbnail('thumbImg' + imageCount, dataUrl);
                      imageCount++;
                    }
                  });


                }, false);

                // Creating thumbnails..
                // 'canvasImg'
                function createThumbnail(imgId, dataUrl) {
                  var dim = 64;
                  img = document.getElementById(imgId);
                  img.height = dim;
                  img.width = dim;
                  img.src = dataUrl;
                  img.setAttribute('onclick', 'window.open("' + dataUrl + '");')
                }

                document.getElementById("addDiagnosis").addEventListener("click", function() {
                  // Get user input
                  console.log("add diagnosis")
                  // var input = window.prompt("What's the diagnosis?","Tuberculosis");
                  
                  // inserts a dianosis wherever there's untouched space on canvas
                  drawTextAtLowPoint("FAKE DIAGNOSIS 123");
                  // drawTextAtLowPoint(input);

                }, false);

                function drawTextAtLowPoint(text) {
                  console.log("drawTextAtLowPoint");
                  
                  // add the shapes to the layer
                  simpleText.setAttrs({y: highY});
                  console.log(simpleText);
                  console.log(simpleText.y);
                  textLayer.add(simpleText);
                  complexText.setAttrs({y: highY + 45});
                  textLayer.add(complexText);
                  stage.draw();
                } 
            };
        </script>
    </head>
    <body>
        <div id="container" ></div>
        <button id="drawMode">
          Draw
        </button>
        <button id="eraseMode">
          Erase
        </button>
        <button id="saveCanvas">
          saveCanvas
        </button>
        <button id="addDiagnosis">
          + Diagnosis
        </button>
        <div id="thumbs">
          <a id='thumbLink1' href='#'>
            <img border="1" id="thumbImg0" alt="Right click to save me!">
            <img border="1" id="thumbImg1" alt="Right click to save me!">
            <img border="1" id="thumbImg2" alt="Right click to save me!">
            <img border="1" id="thumbImg3" alt="Right click to save me!">
            <img border="1" id="thumbImg4" alt="Right click to save me!">
          </a>
        </div>
    </body>
</html>